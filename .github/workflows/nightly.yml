name: Nightly Build

on:
  workflow_run:
    workflows: ["E2E Nightly Suite"]
    types:
      - completed
  workflow_dispatch:

env:
  GO_VERSION: '1.24.4'

jobs:
  build:
    # Only run if triggered manually OR if the E2E nightly suite succeeded
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get commit info
        id: commit
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "COMMIT_DATE=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT

      - name: Set version
        id: version
        run: |
          VERSION="nightly-${{ steps.commit.outputs.COMMIT_DATE }}-${{ steps.commit.outputs.SHORT_SHA }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-w -s -X main.version=${{ steps.version.outputs.VERSION }}" -o andurel-linux-amd64 .
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -ldflags "-w -s -X main.version=${{ steps.version.outputs.VERSION }}" -o andurel-darwin-amd64 .
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -ldflags "-w -s -X main.version=${{ steps.version.outputs.VERSION }}" -o andurel-darwin-arm64 .

      - name: Generate checksums
        run: |
          sha256sum andurel-* > checksums.txt
          cat checksums.txt

      - name: Delete existing nightly release
        run: gh release delete nightly --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete existing nightly tag
        run: git push origin :refs/tags/nightly || true

      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly Build (${{ steps.commit.outputs.COMMIT_DATE }})
          body: |
            This is an automated nightly build from the `master` branch.

            **Commit:** ${{ github.sha }}
            **Date:** ${{ steps.commit.outputs.COMMIT_DATE }}
            **Version:** ${{ steps.version.outputs.VERSION }}

            > **Warning**: Nightly builds are automatically generated from the latest code and may contain bugs or breaking changes. For stable releases, please use the [latest release](https://github.com/${{ github.repository }}/releases/latest).

            ## Installation

            Download the appropriate binary for your platform below, make it executable, and place it in your GOBIN directory.

            > **Note**: Do not use `go install` for nightly builds - it builds from source and won't include the version info. Use the pre-built binaries below instead.

            **Linux (amd64)**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/nightly/andurel-linux-amd64 -o andurel
            chmod +x andurel
            mv andurel $(go env GOBIN)/
            ```

            **macOS (Apple Silicon)**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/nightly/andurel-darwin-arm64 -o andurel
            chmod +x andurel
            mv andurel $(go env GOBIN)/
            ```

            **macOS (Intel)**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/nightly/andurel-darwin-amd64 -o andurel
            chmod +x andurel
            mv andurel $(go env GOBIN)/
            ```

            ## Checksums
            ```
            $(cat checksums.txt)
            ```
          prerelease: true
          files: |
            andurel-linux-amd64
            andurel-darwin-amd64
            andurel-darwin-arm64
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-failure:
    needs: [build]
    if: always() && needs.build.result == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly build failed on ${new Date().toISOString().split('T')[0]}`;
            const body = `The nightly build workflow failed.

            **Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            Please investigate the failure.`;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 1
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['nightly-failure', 'ci']
              });
            } else {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another nightly build failure:\n\n${body}`
              });
            }
