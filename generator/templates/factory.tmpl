package factories

import (
	"context"
	"fmt"
{{- range .StandardImports}}
	"{{.}}"
{{- end}}

	"{{.ModulePath}}/models"
	"{{.ModulePath}}/internal/storage"
{{- range .ExternalImports}}
	"{{.}}"
{{- end}}
)

// {{.ModelName}}Factory wraps models.{{.ModelName}} for testing
type {{.ModelName}}Factory struct {
	models.{{.ModelName}}  // Embedded
}

type {{.ModelName}}Option func(*{{.ModelName}}Factory)

// Build{{.ModelName}} creates an in-memory {{.ModelName}} with default test values
func Build{{.ModelName}}({{- range .Fields}}{{- if .IsFK}}{{.ArgumentName}} {{.Type}}, {{end}}{{end}}opts ...{{.ModelName}}Option) models.{{.ModelName}} {
	f := &{{.ModelName}}Factory{
		{{.ModelName}}: models.{{.ModelName}}{
{{- range .Fields}}
{{- if .IsID}}
			{{.Name}}: uuid.New(),
{{- else if .IsTimestamp}}
{{- if eq .Name "CreatedAt"}}
			{{.Name}}: time.Now(),
{{- else if eq .Name "UpdatedAt"}}
			{{.Name}}: time.Now(),
{{- else}}
			{{.Name}}: {{.GoZero}},  // Optional timestamp - zero by default
{{- end}}
{{- else if .IsFK}}
			{{.Name}}: {{.ArgumentName}},  // Foreign key - required parameter
{{- else}}
			{{.Name}}: {{.DefaultValue}},
{{- end}}
{{- end}}
		},
	}

	for _, opt := range opts {
		opt(f)
	}

	return f.{{.ModelName}}
}

{{if .HasCreateFunction}}
// Create{{.ModelName}} creates and persists a {{.ModelName}} to the database
func Create{{.ModelName}}(ctx context.Context, exec storage.Executor, {{- range .Fields}}{{- if .IsFK}}{{.ArgumentName}} {{.Type}}, {{end}}{{end}}opts ...{{.ModelName}}Option) (models.{{.ModelName}}, error) {
	// Build with defaults and required FKs
	built := Build{{.ModelName}}({{- range .Fields}}{{- if .IsFK}}{{.ArgumentName}}, {{end}}{{end}}opts...)

	// Prepare creation data
	data := models.Create{{.ModelName}}Data{
{{- range .Fields}}
{{- if not .IsAutoManaged}}
		{{.Name}}: built.{{.Name}},
{{- end}}
{{- end}}
	}

	// Use model's Create function
	{{.ModelName | toLower}}, err := models.Create{{.ModelName}}(ctx, exec, data)
	if err != nil {
		return models.{{.ModelName}}{}, err
	}

	return {{.ModelName | toLower}}, nil
}

// Create{{.ModelName}}s creates multiple {{.ModelName}} records at once
func Create{{.ModelName}}s(ctx context.Context, exec storage.Executor, {{range .ForeignKeyFields}}{{.ArgumentName}} {{.Type}}, {{end}}count int, opts ...{{.ModelName}}Option) ([]models.{{.ModelName}}, error) {
	{{.ModelName | toLower}}s := make([]models.{{.ModelName}}, 0, count)

	for i := 0; i < count; i++ {
		{{.ModelName | toLower}}, err := Create{{.ModelName}}(ctx, exec, {{range .ForeignKeyFields}}{{.ArgumentName}}, {{end}}opts...)
		if err != nil {
			return nil, fmt.Errorf("failed to create {{.ModelName | toLower}} %d: %w", i+1, err)
		}
		{{.ModelName | toLower}}s = append({{.ModelName | toLower}}s, {{.ModelName | toLower}})
	}

	return {{.ModelName | toLower}}s, nil
}
{{end}}

// Option functions
{{- range .Fields}}
{{- if not .IsAutoManaged}}

// {{.OptionName}} sets the {{.Name}} field
func {{.OptionName}}(value {{.Type}}) {{$.ModelName}}Option {
	return func(f *{{$.ModelName}}Factory) {
		f.{{$.ModelName}}.{{.Name}} = value
	}
}
{{- end}}
{{- end}}
