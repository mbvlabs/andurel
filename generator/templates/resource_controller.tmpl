package controllers

import (
	"fmt"
	"log/slog"
	"net/http"
	"strconv"
{{- range .Fields}}
{{- if and (not .IsSystemField) (eq .GoFormType "time.Time")}}
	"time"
{{- break}}
{{- end}}
{{- end}}

	"github.com/google/uuid"
	"github.com/labstack/echo/v5"
	"{{.ModulePath}}/models"
	"{{.ModulePath}}/internal/storage"
	"{{.ModulePath}}/router/cookies"
	"{{.ModulePath}}/router/routes"
	"{{.ModulePath}}/views"
)

type {{.PluralResourceName}} struct {
	db storage.Pool
}

func New{{.PluralResourceName}}(db storage.Pool) {{.PluralResourceName}} {
	return {{.PluralResourceName}}{db}
}

func ({{.ReceiverName}} {{.PluralResourceName}}) Index(etx *echo.Context) error {
	page := int64(1)
	if p := etx.QueryParam("page"); p != "" {
		if parsed, err := strconv.Atoi(p); err == nil && parsed > 0 {
			page = int64(parsed)
		}
	}

	perPage := int64(25)
	if pp := etx.QueryParam("per_page"); pp != "" {
		if parsed, err := strconv.Atoi(pp); err == nil && parsed > 0 &&
			parsed <= 100 {
			perPage = int64(parsed)
		}
	}

	{{.PluralName | ToCamelCase}}List, err := models.Paginate{{.PluralResourceName}}(
		etx.Request().Context(),
		{{.ReceiverName}}.db.Conn(),
		page,
		perPage,
	)
	if err != nil {
		return render(etx, views.InternalError())
	}

	return render(etx, views.{{.ResourceName}}Index({{.PluralName | ToCamelCase}}List.{{.PluralResourceName}}))
}

func ({{.ReceiverName}} {{.PluralResourceName}}) Show(etx *echo.Context) error {
	{{.ResourceName | ToLowerCamelCase}}ID, err := uuid.Parse(etx.Param("id"))
	if err != nil {
		return render(etx, views.BadRequest())
	}

	{{.ResourceName | ToLowerCamelCase}}, err := models.Find{{.ResourceName}}(etx.Request().Context(), {{.ReceiverName}}.db.Conn(), {{.ResourceName | ToLowerCamelCase}}ID)
	if err != nil {
		return render(etx, views.NotFound())
	}

	return render(etx, views.{{.ResourceName}}Show({{.ResourceName | ToLowerCamelCase}}))
}

func ({{.ReceiverName}} {{.PluralResourceName}}) New(etx *echo.Context) error {
	return render(etx, views.{{.ResourceName}}New())
}

type Create{{.ResourceName}}FormPayload struct {
{{- range .Fields}}
{{- if not .IsSystemField}}
	{{- if eq .GoFormType "time.Time"}}
	{{.Name}}    string `json:"{{.CamelCase}}"`
	{{- else}}
	{{.Name}}    {{.GoFormType}} `json:"{{.CamelCase}}"`
	{{- end}}
{{- end}}
{{- end}}
}

func ({{.ReceiverName}} {{.PluralResourceName}}) Create(etx *echo.Context) error {
	var payload Create{{.ResourceName}}FormPayload
	if err := etx.Bind(&payload); err != nil {
		slog.ErrorContext(
			etx.Request().Context(),
			"could not parse Create{{.ResourceName}}FormPayload",
			"error",
			err,
		)

		return render(etx, views.NotFound())
	}

	data := models.Create{{.ResourceName}}Data{
{{- range .Fields}}
{{- if not .IsSystemField}}
		{{- if eq .GoType "uuid.UUID"}}
		{{.Name}}:    func() uuid.UUID {
			if payload.{{.Name}} == "" {
				return uuid.Nil
			}
			parsed, err := uuid.Parse(payload.{{.Name}})
			if err != nil {
				slog.WarnContext(
					etx.Request().Context(),
					"could not parse {{.Name}}, setting to nil UUID",
					"error",
					err,
				)
				return uuid.Nil
			}

			return parsed
		}(),
		{{- else if eq .GoType "[]byte"}}
		{{.Name}}:    []byte(payload.{{.Name}}),
		{{- else if eq .GoFormType "time.Time"}}
		{{.Name}}:    func() time.Time {
			if payload.{{.Name}} == "" {
				return time.Time{}
			}
			if t, err := time.Parse("2006-01-02", payload.{{.Name}}); err == nil {
				return t
			}
			return time.Time{}
		}(),
		{{- else}}
		{{.Name}}:    payload.{{.Name}},
		{{- end}}
{{- end}}
{{- end}}
	}

	{{.ResourceName | ToLowerCamelCase}}, err := models.Create{{.ResourceName}}(
		etx.Request().Context(),
		{{.ReceiverName}}.db.Conn(),
		data,
	)
	if err != nil {
		if flashErr := cookies.AddFlash(etx, cookies.FlashError, fmt.Sprintf("Failed to create {{.ResourceName | ToLowerCamelCase}}: %v", err)); flashErr != nil {
			return flashErr
		}
		return etx.Redirect(http.StatusSeeOther, routes.{{.ResourceName}}New.URL())
	}

	if flashErr := cookies.AddFlash(etx, cookies.FlashSuccess, "{{.ResourceName}} created successfully"); flashErr != nil {
		return render(etx, views.InternalError())
	}

	return etx.Redirect(http.StatusSeeOther, routes.{{.ResourceName}}Show.URL({{.ResourceName | ToLowerCamelCase}}.ID))
}

func ({{.ReceiverName}} {{.PluralResourceName}}) Edit(etx *echo.Context) error {
	{{.ResourceName | ToLowerCamelCase}}ID, err := uuid.Parse(etx.Param("id"))
	if err != nil {
		return render(etx, views.BadRequest())
	}

	{{.ResourceName | ToLowerCamelCase}}, err := models.Find{{.ResourceName}}(etx.Request().Context(), {{.ReceiverName}}.db.Conn(), {{.ResourceName | ToLowerCamelCase}}ID)
	if err != nil {
		return render(etx, views.NotFound())
	}

	return render(etx, views.{{.ResourceName}}Edit({{.ResourceName | ToLowerCamelCase}}))
}

type Update{{.ResourceName}}FormPayload struct {
{{- range .Fields}}
{{- if not .IsSystemField}}
	{{- if eq .GoFormType "time.Time"}}
	{{.Name}}    string `json:"{{.CamelCase}}"`
	{{- else}}
	{{.Name}}    {{.GoFormType}} `json:"{{.CamelCase}}"`
	{{- end}}
{{- end}}
{{- end}}
}

func ({{.ReceiverName}} {{.PluralResourceName}}) Update(etx *echo.Context) error {
	{{.ResourceName | ToLowerCamelCase}}ID, err := uuid.Parse(etx.Param("id"))
	if err != nil {
		return render(etx, views.BadRequest())
	}

	var payload Update{{.ResourceName}}FormPayload
	if err := etx.Bind(&payload ); err != nil {
		slog.ErrorContext(
			etx.Request().Context(),
			"could not parse Update{{.ResourceName}}FormPayload",
			"error",
			err,
		)

		return render(etx, views.NotFound())
	}

	data := models.Update{{.ResourceName}}Data{
		ID:      {{.ResourceName | ToLowerCamelCase}}ID,
{{- range .Fields}}
{{- if not .IsSystemField}}
		{{- if eq .GoType "uuid.UUID"}}
		{{.Name}}:    func() uuid.UUID {
			if payload.{{.Name}} == "" {
				return uuid.Nil
			}
			parsed, err := uuid.Parse(payload.{{.Name}})
			if err != nil {
				slog.WarnContext(
					etx.Request().Context(),
					"could not parse {{.Name}}, setting to nil UUID",
					"error",
					err,
				)
				return uuid.Nil
			}

			return parsed
		}(),
		{{- else if eq .GoType "[]byte"}}
		{{.Name}}:    []byte(payload.{{.Name}}),
		{{- else if eq .GoFormType "time.Time"}}
		{{.Name}}:    func() time.Time {
			if payload.{{.Name}} == "" {
				return time.Time{}
			}
			if t, err := time.Parse("2006-01-02", payload.{{.Name}}); err == nil {
				return t
			}
			return time.Time{}
		}(),
		{{- else}}
		{{.Name}}:    payload.{{.Name}},
		{{- end}}
{{- end}}
{{- end}}
	}

	{{.ResourceName | ToLowerCamelCase}}, err := models.Update{{.ResourceName}}(
		etx.Request().Context(),
		{{.ReceiverName}}.db.Conn(),
		data,
	)
	if err != nil {
		if flashErr := cookies.AddFlash(etx, cookies.FlashError, fmt.Sprintf("Failed to update {{.ResourceName | ToLowerCamelCase}}: %v", err)); flashErr != nil {
			return render(etx, views.InternalError())
		}
		return etx.Redirect(
			http.StatusSeeOther,
			routes.{{.ResourceName}}Edit.URL({{.ResourceName | ToLowerCamelCase}}ID),
		)
	}

	if flashErr := cookies.AddFlash(etx, cookies.FlashSuccess, "{{.ResourceName}} updated successfully"); flashErr != nil {
		return render(etx, views.InternalError())
	}

	return etx.Redirect(http.StatusSeeOther, routes.{{.ResourceName}}Show.URL({{.ResourceName | ToLowerCamelCase}}.ID))
}

func ({{.ReceiverName}} {{.PluralResourceName}}) Destroy(etx *echo.Context) error {
	{{.ResourceName | ToLowerCamelCase}}ID, err := uuid.Parse(etx.Param("id"))
	if err != nil {
		return render(etx, views.BadRequest())
	}

	err = models.Destroy{{.ResourceName}}(etx.Request().Context(), {{.ReceiverName}}.db.Conn(), {{.ResourceName | ToLowerCamelCase}}ID)
	if err != nil {
		if flashErr := cookies.AddFlash(etx, cookies.FlashError, fmt.Sprintf("Failed to delete {{.ResourceName | ToLowerCamelCase}}: %v", err)); flashErr != nil {
			return render(etx, views.InternalError())
		}
		return etx.Redirect(http.StatusSeeOther, routes.{{.ResourceName}}Index.URL())
	}

	if flashErr := cookies.AddFlash(etx, cookies.FlashSuccess, "{{.ResourceName}} destroyed successfully"); flashErr != nil {
		return render(etx, views.InternalError())
	}

	return etx.Redirect(http.StatusSeeOther, routes.{{.ResourceName}}Index.URL())
}
