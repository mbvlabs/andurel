package models

import (
	"context"
	"time"

	"github.com/google/uuid"

	"{{.ModuleName}}/models/internal/db"
	"{{.ModuleName}}/internal/storage"
)

type PaymentCustomer struct {
	ID               uuid.UUID
	CreatedAt        time.Time
	UpdatedAt        time.Time
	ProviderCustomerID string
	Email            string
}

func FindPaymentCustomerByProviderID(
	ctx context.Context,
	exec storage.Executor,
	paddleCustomerID string,
) (PaymentCustomer, error) {
	row, err := queries.QueryPaymentCustomerByProviderID(ctx, exec, paddleCustomerID)
	if err != nil {
		return PaymentCustomer{}, err
	}

	return rowToPaymentCustomer(row)
}

type CreatePaymentCustomerData struct {
	ProviderCustomerID string
	Email            string
}

func CreatePaymentCustomer(
	ctx context.Context,
	exec storage.Executor,
	data CreatePaymentCustomerData,
) (PaymentCustomer, error) {
	params := db.BuildInsertPaymentCustomerParams(
		uuid.New(),
		data.ProviderCustomerID,
		data.Email,
	)

	row, err := queries.InsertPaymentCustomer(ctx, exec, params)
	if err != nil {
		return PaymentCustomer{}, err
	}

	return rowToPaymentCustomer(row)
}

func rowToPaymentCustomer(row db.PaymentCustomer) (PaymentCustomer, error) {
	return PaymentCustomer{
		ID:               row.ID,
		CreatedAt:        row.CreatedAt.Time,
		UpdatedAt:        row.UpdatedAt.Time,
		ProviderCustomerID: row.ProviderCustomerID,
		Email:            row.Email,
	}, nil
}
