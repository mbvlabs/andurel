package models

import (
	"context"
	"database/sql"
	"time"

	"github.com/google/uuid"

	"{{.ModuleName}}/models/internal/db"
	"{{.ModuleName}}/internal/storage"
)

type PaymentProduct struct {
	ID              uuid.UUID
	CreatedAt       time.Time
	UpdatedAt       time.Time
	ProviderProductID string
	ProviderPriceID   string
	Name            string
	Description     string
	PriceAmount     string
	PriceCurrency   string
	ImageURL        string
	IsActive        bool
}

func FindPaymentProductByID(
	ctx context.Context,
	exec storage.Executor,
	id uuid.UUID,
) (PaymentProduct, error) {
	row, err := queries.QueryPaymentProductByID(ctx, exec, id)
	if err != nil {
		return PaymentProduct{}, err
	}

	return rowToPaymentProduct(row)
}

func FindPaymentProductByProviderID(
	ctx context.Context,
	exec storage.Executor,
	paddleProductID string,
) (PaymentProduct, error) {
	row, err := queries.QueryPaymentProductByProviderID(ctx, exec, paddleProductID)
	if err != nil {
		return PaymentProduct{}, err
	}

	return rowToPaymentProduct(row)
}

func ListActiveProducts(
	ctx context.Context,
	exec storage.Executor,
) ([]PaymentProduct, error) {
	rows, err := queries.QueryActiveProducts(ctx, exec)
	if err != nil {
		return nil, err
	}

	products := make([]PaymentProduct, len(rows))
	for i, row := range rows {
		product, convErr := rowToPaymentProduct(row)
		if convErr != nil {
			return nil, convErr
		}
		products[i] = product
	}

	return products, nil
}

type CreatePaymentProductData struct {
	ProviderProductID string
	ProviderPriceID   string
	Name            string
	Description     string
	PriceAmount     string
	PriceCurrency   string
	ImageURL        string
	IsActive        bool
}

func CreatePaymentProduct(
	ctx context.Context,
	exec storage.Executor,
	data CreatePaymentProductData,
) (PaymentProduct, error) {
	params := db.InsertPaymentProductParams{
		ID:                uuid.New(),
		ProviderProductID: data.ProviderProductID,
		ProviderPriceID:   data.ProviderPriceID,
		Name:              data.Name,
		Description:       sql.NullString{String: data.Description, Valid: data.Description != ""},
		PriceAmount:       data.PriceAmount,
		PriceCurrency:     data.PriceCurrency,
		ImageURL:          sql.NullString{String: data.ImageURL, Valid: data.ImageURL != ""},
		IsActive:          data.IsActive,
	}

	row, err := queries.InsertPaymentProduct(ctx, exec, params)
	if err != nil {
		return PaymentProduct{}, err
	}

	return rowToPaymentProduct(row)
}

func rowToPaymentProduct(row db.PaymentProduct) (PaymentProduct, error) {
	return PaymentProduct{
		ID:              row.ID,
		CreatedAt:       row.CreatedAt.Time,
		UpdatedAt:       row.UpdatedAt.Time,
		ProviderProductID: row.ProviderProductID,
		ProviderPriceID:   row.ProviderPriceID,
		Name:            row.Name,
		Description:     row.Description.String,
		PriceAmount:     row.PriceAmount,
		PriceCurrency:   row.PriceCurrency,
		ImageURL:        row.ImageUrl.String,
		IsActive:        row.IsActive,
	}, nil
}
