package components

// FieldProp represents the state of a form field, including its value and any associated error message.
type FieldState struct {
	Value string
	Error string
}

type FormProps struct {
	Method string
	URL    string
}

type formData struct {
	css          string
	overrideCSS  string
	addCSSClass  []string
	isFragment   bool
	fragmentName string
}

type formDataOptions func(*formData)

func OverrideFormCSS(css string) formDataOptions {
	return func(fd *formData) {
		fd.overrideCSS = css
	}
}

func AddCssToForm(classes ...string) formDataOptions {
	return func(fd *formData) {
		fd.addCSSClass = append(fd.addCSSClass, classes...)
	}
}

func WithFormFragment(name string) formDataOptions {
	return func(fd *formData) {
		fd.isFragment = true
		fd.fragmentName = name
	}
}

templ formBase(css, method, url string) {
	<form
		class={ css }
		data-indicator:submitting
		data-on:submit={ "!$submitting &&" + hypermedia.DataAction(method, url) }
	>
		{ children... }
	</form>
}

templ Form(prop FormProps, options ...formDataOptions) {
	{{
		data := &formData{
			css:          "grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6",
			overrideCSS:  "",
			isFragment:   false,
			fragmentName: "",
			addCSSClass:  []string{},
		}
		for _, option := range options {
			option(data)
		}

		if data.overrideCSS != "" {
			data.css = data.overrideCSS
		} else if len(data.addCSSClass) > 0 {
			for _, class := range data.addCSSClass {
				data.css += " " + class
			}
		}
	}}
	if data.isFragment {
		@templ.Fragment(data.fragmentName) {
			@formBase(data.css, prop.Method, prop.URL) {
				{ children... }
			}
		}
	}
	if !data.isFragment {
		@formBase(data.css, prop.Method, prop.URL) {
			{ children... }
		}
	}
}

type inputFieldData struct {
	placeholder     string
	required        bool
	isFragment      bool
	customName      string
	disableOnSubmit bool
	fieldType       string
}

type InputFieldOptions func(*inputFieldData)

func SetRequired(required bool) InputFieldOptions {
	return func(ifad *inputFieldData) {
		ifad.required = required
	}
}

func SetDisableOnSubmit(disable bool) InputFieldOptions {
	return func(ifad *inputFieldData) {
		ifad.disableOnSubmit = disable
	}
}

func WithPlaceholder(placeholder string) InputFieldOptions {
	return func(ifad *inputFieldData) {
		ifad.placeholder = placeholder
	}
}

func WithCustomName(name string) InputFieldOptions {
	return func(ifad *inputFieldData) {
		ifad.customName = name
	}
}

func WithFieldType(fieldType string) InputFieldOptions {
	return func(ifad *inputFieldData) {
		ifad.fieldType = fieldType
	}
}

func WithFragment(fragment bool) InputFieldOptions {
	return func(ifad *inputFieldData) {
		ifad.isFragment = fragment
	}
}

type InputProps struct {
	Title string
	State FieldState
}

// TODO: needs css override options like Form
templ inputBase(title, name, inputType, value, placeholder, errorMsg string, required, disableOnSubmit bool) {
	<div class="grid gap-2">
		<label
			class="label"
			for={ name }
		>
			{ title }
		</label>
		<input
			id={ name }
			class="input"
			type={ inputType }
			if value != "" {
				value={ value }
			}
			if placeholder != "" {
				placeholder={ placeholder }
			}
			data-bind={ name }
			if disableOnSubmit {
				data-attr:disabled="$submitting"
			}
			if required {
				required
			}
		/>
		if errorMsg != "" {
			<span>{ errorMsg }</span>
		}
	</div>
}

templ Textarea(label, name, placeholder string, required bool, prop FieldProp) {
	<div>
		<label
			for={ name }
		>
			{ label }
		</label>
		<textarea
			id={ name }
			placeholder={ placeholder }
			data-bind={ name }
			data-attr:disabled="$submitting"
			if required {
				required
			}
		>
			{ prop.Value }
		</textarea>
		if prop.Error != "" {
			<span>{ prop.Error }</span>
		}
	</div>
}

templ SubmitButton(title string) {
	<button
		type="submit"
		data-attr:disabled="$submitting"
	>
		<span
			data-show="!$submitting"
		>
			{ title }
		</span>
		<span
			data-show="$submitting"
		>
			Loading
		</span>
	</button>
}
