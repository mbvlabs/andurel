// Package routes provides the application route definitions.
package routes

import (
	"net/http"
	"strings"

	"github.com/google/uuid"
	"github.com/labstack/echo/v4"
)

type routeMiddleware interface {
	Handler() func(next echo.HandlerFunc) echo.HandlerFunc
}

type Route string

func (r Route) URL() string {
	return string(r)
}

type RouteWithID Route

func (r RouteWithID) URL(id uuid.UUID) string {
	return strings.Replace(string(r), ":id", id.String(), 1)
}

type RouteWithSlug Route

func (r RouteWithSlug) URL(slug string) string {
	return strings.Replace(string(r), ":slug", slug, 1)
}

type RouteWithToken Route

func (r RouteWithToken) URL(token string) string {
	return strings.Replace(string(r), ":token", token, 1)
}

type RouteDefinition struct {
	Name             string
	Path             string
	Controller       string
	ControllerMethod string
	Method           string
	IncludeInSitemap bool
	Middleware       []routeMiddleware
}

var Registry = []RouteDefinition{}

type routeBuilder RouteDefinition

func newRouteBuilder(name string) routeBuilder {
	return routeBuilder{
		Name:   name,
		Method: http.MethodGet,
	}
}

func (r routeBuilder) SetNamePrefix(prefix string) routeBuilder {
	r.Name = prefix + "." + r.Name
	return r
}

func (r routeBuilder) SetPath(path string) routeBuilder {
	r.Path = r.Path + path

	return r
}

func (r routeBuilder) SetMethod(method string) routeBuilder {
	r.Method = method
	return r
}

func (r routeBuilder) SetCtrl(ctrlName, ctrlMethod string) routeBuilder {
	r.Controller = ctrlName
	r.ControllerMethod = ctrlMethod

	return r
}

func (r routeBuilder) WithMiddleware(mw ...routeMiddleware) routeBuilder {
	r.Middleware = append(r.Middleware, mw...)
	return r
}

func (r routeBuilder) WithSitemap() routeBuilder {
	r.IncludeInSitemap = true
	return r
}

func (r routeBuilder) Register() Route {
	Registry = append(Registry, RouteDefinition(r))

	return Route(r.Path)
}

func (r routeBuilder) RegisterWithID() RouteWithID {
	Registry = append(Registry, RouteDefinition(r))

	return RouteWithID(r.Path)
}

func (r routeBuilder) RegisterWithSlug() RouteWithSlug {
	Registry = append(Registry, RouteDefinition(r))

	return RouteWithSlug(r.Path)
}

func (r routeBuilder) RegisterWithToken() RouteWithToken {
	Registry = append(Registry, RouteDefinition(r))

	return RouteWithToken(r.Path)
}
