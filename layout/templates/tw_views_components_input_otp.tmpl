package components

import "strconv"

// --- Builder ---

type InputOTPBuilder struct {
	bind       string
	length     int
	id         string
	class      string
	attrs      templ.Attributes
	fragmentID string
}

func InputOTP(bind string) *InputOTPBuilder {
	return &InputOTPBuilder{bind: bind, length: 6}
}

func (b *InputOTPBuilder) WithLength(l int) *InputOTPBuilder       { b.length = l; return b }
func (b *InputOTPBuilder) WithID(id string) *InputOTPBuilder       { b.id = id; return b }
func (b *InputOTPBuilder) WithClass(c string) *InputOTPBuilder     { b.class = cn(b.class, c); return b }
func (b *InputOTPBuilder) SetClass(c string) *InputOTPBuilder      { b.class = c; return b }
func (b *InputOTPBuilder) WithAttr(key string, val any) *InputOTPBuilder {
	if b.attrs == nil { b.attrs = templ.Attributes{} }
	b.attrs[key] = val; return b
}
func (b *InputOTPBuilder) WithFragment(id string) *InputOTPBuilder { b.fragmentID = id; return b }

// --- Class helpers ---

func inputOTPContainerClasses(b *InputOTPBuilder) string {
	return cn("flex items-center gap-2", b.class)
}

func inputOTPSlotClasses() string {
	return "flex h-10 w-10 items-center justify-center rounded-field border border-base-300 bg-base-200 text-sm font-medium text-base-content shadow-inner transition focus-within:border-primary focus-within:ring-2 focus-within:ring-primary/50"
}

// --- Templ ---

templ (b *InputOTPBuilder) Render() {
	if b.fragmentID != "" {
		@templ.Fragment(b.fragmentID) {
			@b.render()
		}
	} else {
		@b.render()
	}
}

templ (b *InputOTPBuilder) render() {
	<div
		class={ inputOTPContainerClasses(b) }
		if b.id != "" {
			id={ b.id }
		}
		if b.attrs != nil {
			{ b.attrs... }
		}
	>
		for i := 0; i < b.length; i++ {
			<div class={ inputOTPSlotClasses() }>
				<input
					type="text"
					maxlength="1"
					class="h-full w-full bg-transparent text-center outline-none"
					data-bind={ b.bind + "_" + strconv.Itoa(i) }
					data-attr:disabled="$submitting"
					inputmode="numeric"
					pattern="[0-9]*"
					autocomplete="one-time-code"
				/>
			</div>
			if i == 2 && b.length == 6 {
				<div class="flex items-center text-base-content/40">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
				</div>
			}
		}
	</div>
}
