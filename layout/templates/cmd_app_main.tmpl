package main

import (
	"context"
	"fmt"
	"log/slog"
	"net"
	"net/http"
	"os"
	"os/signal"
	"time"

	"{{.ModuleName}}/config"
	"{{.ModuleName}}/controllers"
	"{{.ModuleName}}/database"
	"{{.ModuleName}}/router"
{{- range .Blueprint.Controllers.SortedDependencies}}
{{- if .ImportPath}}
	"{{.ImportPath}}"
{{- end}}
{{- end}}

	"github.com/labstack/echo/v4"
	"golang.org/x/sync/errgroup"
)

var appVersion string

func startServer(ctx context.Context, srv *http.Server, env string) error {
	if env == config.ProdEnvironment {
		eg, egCtx := errgroup.WithContext(ctx)

		eg.Go(func() error {
			if err := srv.ListenAndServe(); err != nil &&
				err != http.ErrServerClosed {
				return fmt.Errorf("server error: %w", err)
			}
			return nil
		})

		eg.Go(func() error {
			<-egCtx.Done()
			slog.InfoContext(ctx, "initiating graceful shutdown")
			shutdownCtx, cancel := context.WithTimeout(
				ctx,
				10*time.Second,
			)
			defer cancel()
			if err := srv.Shutdown(shutdownCtx); err != nil {
				return fmt.Errorf("shutdown error: %w", err)
			}
			return nil
		})

		if err := eg.Wait(); err != nil {
			slog.InfoContext(ctx, "wait error", "e", err)
			return err
		}

		return nil
	}

	return srv.ListenAndServe()
}

func setupControllers(
{{- range $i, $dep := .Blueprint.Controllers.SortedDependencies}}
	{{$dep.Name}} {{$dep.Type}},
{{- end}}
) (controllers.Controllers, error) {
	ctrl, err := controllers.New(
{{- range .Blueprint.Controllers.SortedDependencies}}
		{{.Name}},
{{- end}}
	)
	if err != nil {
		return controllers.Controllers{}, err
	}

	return ctrl, nil
}

func setupRouter(ctrl controllers.Controllers, cfg config.Config) (*echo.Echo, error) {
	router, err := router.New(
		ctrl,
		cfg,
	)
	if err != nil {
		return nil, err
	}

	return router.SetupRoutes(), nil
}

func run(ctx context.Context) error {
	ctx, cancel := signal.NotifyContext(ctx, os.Interrupt)
	defer cancel()

	cfg := config.NewConfig()

{{- if eq .Database "postgresql"}}
	db, err := database.NewPostgres(ctx, cfg.DB.GetDatabaseURL())
	if err != nil {
		return err
	}
{{- else if eq .Database "sqlite"}}
	db, err := database.NewSQLite(ctx, cfg.DB.GetDatabaseURL())
	if err != nil {
		return err
	}
{{- end}}

{{- range .Blueprint.Controllers.SortedDependencies}}
{{- if .InitExpr}}
	{{.Name}} := {{.InitExpr}}
{{- end}}
{{- end}}

	controllers, err := setupControllers(
{{- range .Blueprint.Controllers.SortedDependencies}}
		{{.Name}},
{{- end}}
	)
	if err != nil {
		return err
	}

	handler, err := setupRouter(controllers, cfg)
	if err != nil {
		return err
	}

	port := "8080"
	host := "0.0.0.0"

	srv := &http.Server{
		Addr:         fmt.Sprintf("%v:%v", host, port),
		Handler:      handler,
		ReadTimeout:  1 * time.Second,
		WriteTimeout: 5 * time.Second,
		BaseContext:  func(_ net.Listener) context.Context { return ctx },
	}

	slog.InfoContext(ctx, "starting server", "host", host, "port", port)
	return startServer(ctx, srv, config.Env)
}

func main() {
	ctx := context.Background()
	if err := run(ctx); err != nil {
		fmt.Fprintf(os.Stderr, "%s\n", err)
		os.Exit(1)
	}
}
