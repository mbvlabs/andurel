package cookies

import (
	"context"

	"{{.ModuleName}}/config"
	"{{.ModuleName}}/internal/renderer"
{{- range .Blueprint.Cookies.Imports.Items}}
	"{{.}}"
{{- end}}

	"github.com/labstack/echo-contrib/session"
	"github.com/labstack/echo/v5"
)

var AppKey renderer.CookieKey = "app_cookie_context"

{{- if gt (len .Blueprint.Cookies.SortedConstants) 0}}

const (
{{- range .Blueprint.Cookies.SortedConstants}}
	{{.Name}} = "{{.Value}}"
{{- end}}
)
{{- end}}

type App struct {
	*echo.Context
{{- range .Blueprint.Cookies.SortedAppFields}}
	{{.Name}} {{.Type}}
{{- end}}
}

{{- if not (len .Blueprint.Cookies.SortedAppFields)}}
func CreateAppSession(c *echo.Context) error {
{{- else}}
func CreateAppSession(c *echo.Context, user models.User) error {
{{- end}}
	sess, err := session.Get(config.AppCookieSessionName, c)
	if err != nil {
		return err
	}
{{- if .Blueprint.Cookies.CreateSessionCode}}

{{.Blueprint.Cookies.CreateSessionCode}}
{{- end}}

	return sess.Save(c.Request(), c.Response())
}

func DestroyAppSession(c *echo.Context) error {
	sess, err := session.Get(config.AppCookieSessionName, c)
	if err != nil {
		return err
	}

	sess.Options.MaxAge = -1
	return sess.Save(c.Request(), c.Response())
}

func GetAppCtx(ctx context.Context) App {
	appCtx, ok := ctx.Value(AppKey).(App)
	if !ok {
		return App{}
	}

	return appCtx
}

func GetApp(c *echo.Context) App {
{{- if not (len .Blueprint.Cookies.SortedAppFields)}}
	_, err := session.Get(config.AppCookieSessionName, c)
{{- else}}
	sess, err := session.Get(config.AppCookieSessionName, c)
{{- end}}
	if err != nil {
		return App{}
	}

	app := App{Context: c}
{{- if .Blueprint.Cookies.GetSessionCode}}

{{.Blueprint.Cookies.GetSessionCode}}
{{- end}}

	return app
}
{{- range .Blueprint.Cookies.SortedFunctions}}

{{.Code}}
{{- end}}
