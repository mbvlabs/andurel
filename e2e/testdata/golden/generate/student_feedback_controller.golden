package controllers

import (
	"fmt"
	"log/slog"
	"net/http"
	"strconv"

	"testapp/internal/storage"
	"testapp/models"
	"testapp/router/cookies"
	"testapp/router/routes"
	"testapp/views"

	"github.com/google/uuid"
	"github.com/labstack/echo/v4"
)

type StudentFeedback struct {
	db storage.Pool
}

func NewStudentFeedback(db storage.Pool) StudentFeedback {
	return StudentFeedback{db}
}

func (sf StudentFeedback) Index(eCtx echo.Context) error {
	page := int64(1)
	if p := eCtx.QueryParam("page"); p != "" {
		if parsed, err := strconv.Atoi(p); err == nil && parsed > 0 {
			page = int64(parsed)
		}
	}

	perPage := int64(25)
	if pp := eCtx.QueryParam("per_page"); pp != "" {
		if parsed, err := strconv.Atoi(pp); err == nil && parsed > 0 &&
			parsed <= 100 {
			perPage = int64(parsed)
		}
	}

	studentFeedbackList, err := models.PaginateStudentFeedback(
		eCtx.Request().Context(),
		sf.db.Conn(),
		page,
		perPage,
	)
	if err != nil {
		return render(eCtx, views.InternalError())
	}

	return render(eCtx, views.StudentFeedbackIndex(studentFeedbackList.StudentFeedback))
}

func (sf StudentFeedback) Show(eCtx echo.Context) error {
	studentFeedbackID, err := uuid.Parse(eCtx.Param("id"))
	if err != nil {
		return render(eCtx, views.BadRequest())
	}

	studentFeedback, err := models.FindStudentFeedback(eCtx.Request().Context(), sf.db.Conn(), studentFeedbackID)
	if err != nil {
		return render(eCtx, views.NotFound())
	}

	return render(eCtx, views.StudentFeedbackShow(studentFeedback))
}

func (sf StudentFeedback) New(eCtx echo.Context) error {
	return render(eCtx, views.StudentFeedbackNew())
}

type CreateStudentFeedbackFormPayload struct {
	StudentID string `form:"student_id"`
	Feedback  string `form:"feedback"`
	Rating    int32  `form:"rating"`
}

func (sf StudentFeedback) Create(eCtx echo.Context) error {
	var payload CreateStudentFeedbackFormPayload
	if err := eCtx.Bind(&payload); err != nil {
		slog.ErrorContext(
			eCtx.Request().Context(),
			"could not parse CreateStudentFeedbackFormPayload",
			"error",
			err,
		)

		return render(eCtx, views.NotFound())
	}

	data := models.CreateStudentFeedbackData{
		StudentID: payload.StudentID,
		Feedback:  payload.Feedback,
		Rating:    payload.Rating,
	}

	studentFeedback, err := models.CreateStudentFeedback(
		eCtx.Request().Context(),
		sf.db.Conn(),
		data,
	)
	if err != nil {
		if flashErr := cookies.AddFlash(eCtx, cookies.FlashError, fmt.Sprintf("Failed to create studentFeedback: %v", err)); flashErr != nil {
			return flashErr
		}
		return eCtx.Redirect(http.StatusSeeOther, routes.StudentFeedbackNew.URL())
	}

	if flashErr := cookies.AddFlash(eCtx, cookies.FlashSuccess, "StudentFeedback created successfully"); flashErr != nil {
		return render(eCtx, views.InternalError())
	}

	return eCtx.Redirect(http.StatusSeeOther, routes.StudentFeedbackShow.URL(studentFeedback.ID))
}

func (sf StudentFeedback) Edit(eCtx echo.Context) error {
	studentFeedbackID, err := uuid.Parse(eCtx.Param("id"))
	if err != nil {
		return render(eCtx, views.BadRequest())
	}

	studentFeedback, err := models.FindStudentFeedback(eCtx.Request().Context(), sf.db.Conn(), studentFeedbackID)
	if err != nil {
		return render(eCtx, views.NotFound())
	}

	return render(eCtx, views.StudentFeedbackEdit(studentFeedback))
}

type UpdateStudentFeedbackFormPayload struct {
	StudentID string `form:"student_id"`
	Feedback  string `form:"feedback"`
	Rating    int32  `form:"rating"`
}

func (sf StudentFeedback) Update(eCtx echo.Context) error {
	studentFeedbackID, err := uuid.Parse(eCtx.Param("id"))
	if err != nil {
		return render(eCtx, views.BadRequest())
	}

	var payload UpdateStudentFeedbackFormPayload
	if err := eCtx.Bind(&payload); err != nil {
		slog.ErrorContext(
			eCtx.Request().Context(),
			"could not parse UpdateStudentFeedbackFormPayload",
			"error",
			err,
		)

		return render(eCtx, views.NotFound())
	}

	data := models.UpdateStudentFeedbackData{
		ID:        studentFeedbackID,
		StudentID: payload.StudentID,
		Feedback:  payload.Feedback,
		Rating:    payload.Rating,
	}

	studentFeedback, err := models.UpdateStudentFeedback(
		eCtx.Request().Context(),
		sf.db.Conn(),
		data,
	)
	if err != nil {
		if flashErr := cookies.AddFlash(eCtx, cookies.FlashError, fmt.Sprintf("Failed to update studentFeedback: %v", err)); flashErr != nil {
			return render(eCtx, views.InternalError())
		}
		return eCtx.Redirect(
			http.StatusSeeOther,
			routes.StudentFeedbackEdit.URL(studentFeedbackID),
		)
	}

	if flashErr := cookies.AddFlash(eCtx, cookies.FlashSuccess, "StudentFeedback updated successfully"); flashErr != nil {
		return render(eCtx, views.InternalError())
	}

	return eCtx.Redirect(http.StatusSeeOther, routes.StudentFeedbackShow.URL(studentFeedback.ID))
}

func (sf StudentFeedback) Destroy(eCtx echo.Context) error {
	studentFeedbackID, err := uuid.Parse(eCtx.Param("id"))
	if err != nil {
		return render(eCtx, views.BadRequest())
	}

	err = models.DestroyStudentFeedback(eCtx.Request().Context(), sf.db.Conn(), studentFeedbackID)
	if err != nil {
		if flashErr := cookies.AddFlash(eCtx, cookies.FlashError, fmt.Sprintf("Failed to delete studentFeedback: %v", err)); flashErr != nil {
			return render(eCtx, views.InternalError())
		}
		return eCtx.Redirect(http.StatusSeeOther, routes.StudentFeedbackIndex.URL())
	}

	if flashErr := cookies.AddFlash(eCtx, cookies.FlashSuccess, "StudentFeedback destroyed successfully"); flashErr != nil {
		return render(eCtx, views.InternalError())
	}

	return eCtx.Redirect(http.StatusSeeOther, routes.StudentFeedbackIndex.URL())
}
